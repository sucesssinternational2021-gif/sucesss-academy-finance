<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMIA - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #1a4f8c;
            --secondary: #f5a623;
            --accent: #4caf50;
            --light: #f8f9fa;
            --dark: #343a40;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --success: #2ecc71;
            --sidebar-width: 250px;
        }
        
        body {
            display: flex;
            min-height: 100vh;
            background-color: #f0f2f5;
            color: #333;
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary) 0%, #0d3a6e 100%);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .logo-container {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .logo i {
            color: var(--secondary);
            font-size: 2.2rem;
        }
        
        .nav-links {
            list-style: none;
            padding: 0 15px;
        }
        
        .nav-links li {
            margin-bottom: 5px;
        }
        
        .nav-links a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .nav-links a i {
            margin-right: 12px;
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }
        
        .nav-links a:hover, .nav-links a.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .nav-links a.active {
            background-color: var(--secondary);
            color: var(--primary);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .header h1 {
            color: var(--primary);
            font-size: 1.8rem;
        }
        
        .header-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .date-display {
            background-color: #f8f9fa;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--secondary);
        }
        
        /* Dashboard Summary Cards */
        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            border-top: 5px solid var(--primary);
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .summary-card.nursery {
            border-top-color: #9b59b6;
        }
        
        .summary-card.primary {
            border-top-color: #3498db;
        }
        
        .summary-card.secondary {
            border-top-color: #e74c3c;
        }
        
        .summary-card.revenue {
            border-top-color: #2ecc71;
        }
        
        .summary-card.pta {
            border-top-color: #f39c12;
        }
        
        .summary-card.levies {
            border-top-color: #1abc9c;
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .card-title i {
            font-size: 1.5rem;
        }
        
        .card-title .nursery-icon {
            color: #9b59b6;
        }
        
        .card-title .primary-icon {
            color: #3498db;
        }
        
        .card-title .secondary-icon {
            color: #e74c3c;
        }
        
        .card-title .revenue-icon {
            color: #2ecc71;
        }
        
        .card-title .pta-icon {
            color: #f39c12;
        }
        
        .card-title .levies-icon {
            color: #1abc9c;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .stat-item {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        .stat-value.positive {
            color: var(--success);
        }
        
        .stat-value.negative {
            color: var(--danger);
        }
        
        .stat-value.neutral {
            color: var(--info);
        }
        
        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .chart-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        /* Recent Activity */
        .recent-activity {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .activity-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .activity-list {
            list-style: none;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            gap: 15px;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .activity-icon.payment {
            background-color: var(--success);
        }
        
        .activity-icon.enrollment {
            background-color: var(--info);
        }
        
        .activity-icon.expense {
            background-color: var(--warning);
        }
        
        .activity-icon.fee {
            background-color: var(--primary);
        }
        
        .activity-details {
            flex: 1;
        }
        
        .activity-text {
            font-weight: 500;
            color: var(--dark);
        }
        
        .activity-time {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .quick-stat-card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .quick-stat-card:hover {
            transform: translateY(-5px);
        }
        
        .quick-stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 1.5rem;
            color: white;
        }
        
        .quick-stat-icon.total-students {
            background-color: var(--primary);
        }
        
        .quick-stat-icon.total-pupils {
            background-color: var(--info);
        }
        
        .quick-stat-icon.total-paid {
            background-color: var(--success);
        }
        
        .quick-stat-icon.total-outstanding {
            background-color: var(--warning);
        }
        
        .quick-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .quick-stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        /* Firebase Status */
        .firebase-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .firebase-status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        
        .firebase-status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 992px) {
            .sidebar {
                width: 80px;
            }
            
            .main-content {
                margin-left: 80px;
            }
            
            .logo span, .nav-links a span {
                display: none;
            }
            
            .nav-links a {
                justify-content: center;
                padding: 15px;
            }
            
            .nav-links a i {
                margin-right: 0;
                font-size: 1.4rem;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-info {
                width: 100%;
                justify-content: space-between;
            }
            
            .dashboard-summary {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .chart-card {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 576px) {
            .main-content {
                padding: 15px;
            }
            
            .quick-stats {
                grid-template-columns: 1fr;
            }
            
            .header-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo-container">
            <a href="dashboard.html" class="logo">
                <i class="fas fa-graduation-cap"></i>
                <span>SMIA</span>
            </a>
        </div>
        
        <ul class="nav-links">
            <li><a href="#" class="active"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
            <li><a href="payments.html"><i class="fas fa-money-check-alt"></i> <span>Payments</span></a></li>
            <li><a href="fees-levies.html"><i class="fas fa-file-invoice-dollar"></i> <span>Fees & Levies</span></a></li>
            <li><a href="pupils.html"><i class="fas fa-users"></i> <span>Pupils</span></a></li>
            <li><a href="students.html"><i class="fas fa-user-graduate"></i> <span>Students</span></a></li>
            <li><a href="expenses.html"><i class="fas fa-receipt"></i> <span>Expenses</span></a></li>
            <li><a href="reports.html"><i class="fas fa-chart-bar"></i> <span>Reports</span></a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
        </ul>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <div class="header">
            <div>
                <h1><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h1>
                <p>Welcome back! Here's what's happening with Success Model International Academy today.</p>
            </div>
            
            <div class="header-info">
                <div class="date-display">
                    <i class="far fa-calendar"></i> <span id="currentDate">Loading...</span>
                </div>
                
                <div id="firebaseStatus" class="firebase-status disconnected">
                    <i class="fas fa-circle"></i>
                    <span>Firebase: Disconnected</span>
                </div>
                
                <div class="user-info">
                    <div class="user-details">
                        <span id="currentUser">Administrator</span>
                    </div>
                    <img src="https://ui-avatars.com/api/?name=Admin+User&background=1a4f8c&color=fff" alt="User">
                </div>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="quick-stat-card">
                <div class="quick-stat-icon total-students">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="quick-stat-value" id="totalStudentsAll">0</div>
                <div class="quick-stat-label">Total Students</div>
            </div>
            
            <div class="quick-stat-card">
                <div class="quick-stat-icon total-pupils">
                    <i class="fas fa-users"></i>
                </div>
                <div class="quick-stat-value" id="totalPupilsAll">0</div>
                <div class="quick-stat-label">Total Pupils</div>
            </div>
            
            <div class="quick-stat-card">
                <div class="quick-stat-icon total-paid">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="quick-stat-value" id="totalPaidAll">₦0</div>
                <div class="quick-stat-label">Total Fees Paid</div>
            </div>
            
            <div class="quick-stat-card">
                <div class="quick-stat-icon total-outstanding">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="quick-stat-value" id="totalOutstandingAll">₦0</div>
                <div class="quick-stat-label">Total Outstanding</div>
            </div>
        </div>
        
        <!-- Dashboard Summary Cards -->
        <div class="dashboard-summary">
            <!-- Nursery Card -->
            <div class="summary-card nursery">
                <div class="card-title">
                    <i class="fas fa-baby-carriage nursery-icon"></i>
                    <span>Nursery Section</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Total Pupils</div>
                        <div class="stat-value neutral" id="nurseryTotal">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Fees Paid</div>
                        <div class="stat-value positive" id="nurseryPaid">₦0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Outstanding</div>
                        <div class="stat-value negative" id="nurseryOutstanding">₦0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Completion Rate</div>
                        <div class="stat-value neutral" id="nurseryCompletion">0%</div>
                    </div>
                </div>
            </div>
            
            <!-- Primary Card -->
            <div class="summary-card primary">
                <div class="card-title">
                    <i class="fas fa-school primary-icon"></i>
                    <span>Primary Section</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Total Pupils</div>
                        <div class="stat-value neutral" id="primaryTotal">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Fees Paid</div>
                        <div class="stat-value positive" id="primaryPaid">₦0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Outstanding</div>
                        <div class="stat-value negative" id="primaryOutstanding">₦0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Completion Rate</div>
                        <div class="stat-value neutral" id="primaryCompletion">0%</div>
                    </div>
                </div>
            </div>
            
            <!-- Secondary Card -->
            <div class="summary-card secondary">
                <div class="card-title">
                    <i class="fas fa-university secondary-icon"></i>
                    <span>Secondary Section</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Total Students</div>
                        <div class="stat-value neutral" id="secondaryTotal">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Fees Paid</div>
                        <div class="stat-value positive" id="secondaryPaid">₦0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Outstanding</div>
                        <div class="stat-value negative" id="secondaryOutstanding">₦0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Completion Rate</div>
                        <div class="stat-value neutral" id="secondaryCompletion">0%</div>
                    </div>
                </div>
            </div>
            
            <!-- Revenue Card -->
            <div class="summary-card revenue">
                <div class="card-title">
                    <i class="fas fa-chart-line revenue-icon"></i>
                    <span>Revenue Summary</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Received</div>
                        <div class="stat-value positive" id="revenueReceived">₦0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Expected</div>
                        <div class="stat-value neutral" id="revenueExpected">₦0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Balance</div>
                        <div class="stat-value negative" id="revenueBalance">₦0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Collection Rate</div>
                        <div class="stat-value neutral" id="collectionRate">0%</div>
                    </div>
                </div>
            </div>
            
            <!-- PTA Card -->
            <div class="summary-card pta">
                <div class="card-title">
                    <i class="fas fa-handshake pta-icon"></i>
                    <span>PTA Summary</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Per Head</div>
                        <div class="stat-value neutral" id="ptaPerHead">₦0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total Expected</div>
                        <div class="stat-value neutral" id="ptaExpected">₦0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total Collected</div>
                        <div class="stat-value positive" id="ptaCollected">₦0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Outstanding</div>
                        <div class="stat-value negative" id="ptaOutstanding">₦0</div>
                    </div>
                </div>
            </div>
            
            <!-- Levies Card -->
            <div class="summary-card levies">
                <div class="card-title">
                    <i class="fas fa-hand-holding-usd levies-icon"></i>
                    <span>Levies Summary</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Per Head</div>
                        <div class="stat-value neutral" id="leviesPerHead">₦0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total Expected</div>
                        <div class="stat-value neutral" id="leviesExpected">₦0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total Collected</div>
                        <div class="stat-value positive" id="leviesCollected">₦0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Outstanding</div>
                        <div class="stat-value negative" id="leviesOutstanding">₦0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-card">
                <h2 class="chart-title"><i class="fas fa-chart-pie"></i> Enrollment Distribution</h2>
                <div class="chart-container">
                    <canvas id="enrollmentChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h2 class="chart-title"><i class="fas fa-chart-bar"></i> Fee Collection Status</h2>
                <div class="chart-container">
                    <canvas id="feeCollectionChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="recent-activity">
            <h2 class="activity-title"><i class="fas fa-history"></i> Recent Activity</h2>
            <ul class="activity-list" id="recentActivity">
                <!-- Activity items will be loaded here -->
            </ul>
        </div>
    </main>
    
    <!-- Firebase Configuration -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC-Xz6BftZJf96JDZu-fUUlR-ldGYG-2gI",
            authDomain: "sucesss-academy.firebaseapp.com",
            projectId: "sucesss-academy",
            storageBucket: "sucesss-academy.firebasestorage.app",
            messagingSenderId: "274982692906",
            appId: "1:274982692906:web:5e39a38451725a3cd13b53",
            measurementId: "G-QLX11V1YHQ"
        };
    </script>
    
    <script>
        // Initialize Firebase
        let db, auth;
        let isFirebaseConnected = false;
        
        function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                isFirebaseConnected = true;
                updateFirebaseStatus(true);
                console.log("Firebase initialized successfully");
                
                // Check if user is authenticated
                auth.onAuthStateChanged(user => {
                    if (user) {
                        document.getElementById('currentUser').textContent = user.displayName || user.email;
                        loadDashboardData();
                    } else {
                        // If not authenticated, use demo data
                        console.log("User not authenticated, using demo data");
                        loadDemoDashboardData();
                    }
                });
                
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                updateFirebaseStatus(false);
                
                // Load demo data if Firebase fails
                loadDemoDashboardData();
            }
        }
        
        function updateFirebaseStatus(connected) {
            const statusElement = document.getElementById('firebaseStatus');
            if (connected) {
                statusElement.innerHTML = '<i class="fas fa-circle"></i> <span>Firebase: Connected</span>';
                statusElement.className = 'firebase-status connected';
                isFirebaseConnected = true;
            } else {
                statusElement.innerHTML = '<i class="fas fa-circle"></i> <span>Firebase: Disconnected (Demo Mode)</span>';
                statusElement.className = 'firebase-status disconnected';
                isFirebaseConnected = false;
            }
        }
        
        // Update current date
        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
        }
        
        // Format currency
        function formatCurrency(amount) {
            return '₦' + amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // Format number with commas
        function formatNumber(num) {
            return num.toLocaleString('en-US');
        }
        
        // Calculate percentage
        function calculatePercentage(part, total) {
            if (total === 0) return '0%';
            return ((part / total) * 100).toFixed(1) + '%';
        }
        
        // Load dashboard data from Firebase
        async function loadDashboardData() {
            try {
                // Fetch all students
                const studentsSnapshot = await db.collection('students').get();
                const students = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Fetch all payments
                const paymentsSnapshot = await db.collection('payments').get();
                const payments = paymentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Process data
                processDashboardData(students, payments);
                
                // Update recent activity
                updateRecentActivity(payments);
                
            } catch (error) {
                console.error("Error loading dashboard data:", error);
                showError("Failed to load data. Using demo data.");
                loadDemoDashboardData();
            }
        }
        
        // Process dashboard data
        function processDashboardData(students, payments) {
            // Initialize counters
            let nurseryTotal = 0, nurseryPaid = 0, nurseryExpected = 0;
            let primaryTotal = 0, primaryPaid = 0, primaryExpected = 0;
            let secondaryTotal = 0, secondaryPaid = 0, secondaryExpected = 0;
            
            let totalStudentsAll = 0;
            let totalPupilsAll = 0;
            let totalPaidAll = 0;
            let totalExpectedAll = 0;
            
            let ptaExpected = 0, ptaCollected = 0;
            let leviesExpected = 0, leviesCollected = 0;
            
            // Process each student
            students.forEach(student => {
                const level = student.level || student.class || '';
                const isPupil = level.toLowerCase().includes('nursery') || level.toLowerCase().includes('primary');
                const isStudent = level.toLowerCase().includes('secondary') || level.toLowerCase().includes('sss') || level.toLowerCase().includes('jss');
                
                // Count by category
                if (level.toLowerCase().includes('nursery')) {
                    nurseryTotal++;
                    totalPupilsAll++;
                } else if (level.toLowerCase().includes('primary')) {
                    primaryTotal++;
                    totalPupilsAll++;
                } else if (isStudent) {
                    secondaryTotal++;
                    totalStudentsAll++;
                }
                
                // Calculate fees
                const studentFees = student.fees || 0;
                const studentPaid = student.paid || 0;
                const studentPTA = student.pta || 0;
                const studentPTAPaid = student.ptaPaid || 0;
                const studentLevies = student.levies || 0;
                const studentLeviesPaid = student.leviesPaid || 0;
                
                // Add to appropriate category
                if (level.toLowerCase().includes('nursery')) {
                    nurseryExpected += studentFees;
                    nurseryPaid += studentPaid;
                } else if (level.toLowerCase().includes('primary')) {
                    primaryExpected += studentFees;
                    primaryPaid += studentPaid;
                } else if (isStudent) {
                    secondaryExpected += studentFees;
                    secondaryPaid += studentPaid;
                }
                
                // Add to totals
                totalExpectedAll += studentFees;
                totalPaidAll += studentPaid;
                
                // Add PTA and levies
                ptaExpected += studentPTA;
                ptaCollected += studentPTAPaid;
                leviesExpected += studentLevies;
                leviesCollected += studentLeviesPaid;
            });
            
            // Calculate outstanding amounts
            const nurseryOutstanding = nurseryExpected - nurseryPaid;
            const primaryOutstanding = primaryExpected - primaryPaid;
            const secondaryOutstanding = secondaryExpected - secondaryPaid;
            const totalOutstandingAll = totalExpectedAll - totalPaidAll;
            
            const ptaOutstanding = ptaExpected - ptaCollected;
            const leviesOutstanding = leviesExpected - leviesCollected;
            
            // Calculate per head amounts
            const totalPupilsAndStudents = totalPupilsAll + totalStudentsAll;
            const ptaPerHead = totalPupilsAndStudents > 0 ? ptaExpected / totalPupilsAndStudents : 0;
            const leviesPerHead = totalPupilsAndStudents > 0 ? leviesExpected / totalPupilsAndStudents : 0;
            
            // Update UI
            updateDashboardUI({
                nurseryTotal, nurseryPaid, nurseryOutstanding, nurseryExpected,
                primaryTotal, primaryPaid, primaryOutstanding, primaryExpected,
                secondaryTotal, secondaryPaid, secondaryOutstanding, secondaryExpected,
                totalStudentsAll, totalPupilsAll, totalPaidAll, totalExpectedAll, totalOutstandingAll,
                ptaPerHead, ptaExpected, ptaCollected, ptaOutstanding,
                leviesPerHead, leviesExpected, leviesCollected, leviesOutstanding
            });
            
            // Update charts
            updateCharts({
                nurseryTotal, primaryTotal, secondaryTotal,
                nurseryPaid, primaryPaid, secondaryPaid,
                nurseryOutstanding, primaryOutstanding, secondaryOutstanding
            });
        }
        
        // Update dashboard UI with data
        function updateDashboardUI(data) {
            // Update quick stats
            document.getElementById('totalStudentsAll').textContent = formatNumber(data.totalStudentsAll);
            document.getElementById('totalPupilsAll').textContent = formatNumber(data.totalPupilsAll);
            document.getElementById('totalPaidAll').textContent = formatCurrency(data.totalPaidAll);
            document.getElementById('totalOutstandingAll').textContent = formatCurrency(data.totalOutstandingAll);
            
            // Update nursery section
            document.getElementById('nurseryTotal').textContent = formatNumber(data.nurseryTotal);
            document.getElementById('nurseryPaid').textContent = formatCurrency(data.nurseryPaid);
            document.getElementById('nurseryOutstanding').textContent = formatCurrency(data.nurseryOutstanding);
            document.getElementById('nurseryCompletion').textContent = calculatePercentage(data.nurseryPaid, data.nurseryExpected);
            
            // Update primary section
            document.getElementById('primaryTotal').textContent = formatNumber(data.primaryTotal);
            document.getElementById('primaryPaid').textContent = formatCurrency(data.primaryPaid);
            document.getElementById('primaryOutstanding').textContent = formatCurrency(data.primaryOutstanding);
            document.getElementById('primaryCompletion').textContent = calculatePercentage(data.primaryPaid, data.primaryExpected);
            
            // Update secondary section
            document.getElementById('secondaryTotal').textContent = formatNumber(data.secondaryTotal);
            document.getElementById('secondaryPaid').textContent = formatCurrency(data.secondaryPaid);
            document.getElementById('secondaryOutstanding').textContent = formatCurrency(data.secondaryOutstanding);
            document.getElementById('secondaryCompletion').textContent = calculatePercentage(data.secondaryPaid, data.secondaryExpected);
            
            // Update revenue section
            document.getElementById('revenueReceived').textContent = formatCurrency(data.totalPaidAll);
            document.getElementById('revenueExpected').textContent = formatCurrency(data.totalExpectedAll);
            document.getElementById('revenueBalance').textContent = formatCurrency(data.totalOutstandingAll);
            document.getElementById('collectionRate').textContent = calculatePercentage(data.totalPaidAll, data.totalExpectedAll);
            
            // Update PTA section
            document.getElementById('ptaPerHead').textContent = formatCurrency(data.ptaPerHead);
            document.getElementById('ptaExpected').textContent = formatCurrency(data.ptaExpected);
            document.getElementById('ptaCollected').textContent = formatCurrency(data.ptaCollected);
            document.getElementById('ptaOutstanding').textContent = formatCurrency(data.ptaOutstanding);
            
            // Update levies section
            document.getElementById('leviesPerHead').textContent = formatCurrency(data.leviesPerHead);
            document.getElementById('leviesExpected').textContent = formatCurrency(data.leviesExpected);
            document.getElementById('leviesCollected').textContent = formatCurrency(data.leviesCollected);
            document.getElementById('leviesOutstanding').textContent = formatCurrency(data.leviesOutstanding);
        }
        
        // Update charts
        let enrollmentChart, feeCollectionChart;
        
        function updateCharts(data) {
            // Enrollment Distribution Chart
            const enrollmentCtx = document.getElementById('enrollmentChart').getContext('2d');
            
            if (enrollmentChart) {
                enrollmentChart.destroy();
            }
            
            enrollmentChart = new Chart(enrollmentCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Nursery', 'Primary', 'Secondary'],
                    datasets: [{
                        data: [data.nurseryTotal, data.primaryTotal, data.secondaryTotal],
                        backgroundColor: [
                            '#9b59b6', // Nursery - Purple
                            '#3498db', // Primary - Blue
                            '#e74c3c'  // Secondary - Red
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = data.nurseryTotal + data.primaryTotal + data.secondaryTotal;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Fee Collection Chart
            const feeCtx = document.getElementById('feeCollectionChart').getContext('2d');
            
            if (feeCollectionChart) {
                feeCollectionChart.destroy();
            }
            
            feeCollectionChart = new Chart(feeCtx, {
                type: 'bar',
                data: {
                    labels: ['Nursery', 'Primary', 'Secondary'],
                    datasets: [
                        {
                            label: 'Paid',
                            data: [data.nurseryPaid, data.primaryPaid, data.secondaryPaid],
                            backgroundColor: '#2ecc71', // Green
                            borderColor: '#2ecc71',
                            borderWidth: 1
                        },
                        {
                            label: 'Outstanding',
                            data: [data.nurseryOutstanding, data.primaryOutstanding, data.secondaryOutstanding],
                            backgroundColor: '#e74c3c', // Red
                            borderColor: '#e74c3c',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₦' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Update recent activity
        function updateRecentActivity(payments) {
            const activityList = document.getElementById('recentActivity');
            activityList.innerHTML = '';
            
            // Sort payments by date (most recent first)
            const recentPayments = payments
                .sort((a, b) => new Date(b.date || b.timestamp) - new Date(a.date || a.timestamp))
                .slice(0, 5);
            
            if (recentPayments.length === 0) {
                // Add sample activities if no payments
                const sampleActivities = [
                    { type: 'payment', text: 'No recent payments. Payments will appear here.', time: 'Just now' },
                    { type: 'enrollment', text: 'System initialized successfully', time: 'Today' },
                    { type: 'fee', text: 'Dashboard loaded with demo data', time: 'Today' }
                ];
                
                sampleActivities.forEach(activity => {
                    const activityItem = createActivityItem(activity);
                    activityList.appendChild(activityItem);
                });
            } else {
                // Add real payment activities
                recentPayments.forEach(payment => {
                    const activity = {
                        type: 'payment',
                        text: `${payment.studentName || 'Student'} paid ${formatCurrency(payment.amount || 0)} for ${payment.type || 'fees'}`,
                        time: formatTimeAgo(payment.date || payment.timestamp)
                    };
                    const activityItem = createActivityItem(activity);
                    activityList.appendChild(activityItem);
                });
            }
        }
        
        // Create activity item
        function createActivityItem(activity) {
            const li = document.createElement('li');
            li.className = 'activity-item';
            
            const iconClass = {
                'payment': 'fas fa-money-bill-wave payment',
                'enrollment': 'fas fa-user-plus enrollment',
                'expense': 'fas fa-receipt expense',
                'fee': 'fas fa-file-invoice-dollar fee'
            };
            
            li.innerHTML = `
                <div class="activity-icon ${activity.type}">
                    <i class="${iconClass[activity.type] || 'fas fa-info-circle'}"></i>
                </div>
                <div class="activity-details">
                    <div class="activity-text">${activity.text}</div>
                    <div class="activity-time">${activity.time}</div>
                </div>
            `;
            
            return li;
        }
        
        // Format time ago
        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'Recently';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 60) {
                return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            } else if (diffDays < 7) {
                return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }
        
        // Show error message
        function showError(message) {
            console.error(message);
            // You could show a notification here
        }
        
        // Load demo data
        function loadDemoDashboardData() {
            // Demo data
            const demoData = {
                nurseryTotal: 45,
                nurseryPaid: 4250000,
                nurseryExpected: 5400000,
                nurseryOutstanding: 1150000,
                
                primaryTotal: 120,
                primaryPaid: 10800000,
                primaryExpected: 14400000,
                primaryOutstanding: 3600000,
                
                secondaryTotal: 80,
                secondaryPaid: 11200000,
                secondaryExpected: 16000000,
                secondaryOutstanding: 4800000,
                
                totalStudentsAll: 80,
                totalPupilsAll: 165,
                totalPaidAll: 26250000,
                totalExpectedAll: 35800000,
                totalOutstandingAll: 9550000,
                
                ptaPerHead: 5000,
                ptaExpected: 1225000,
                ptaCollected: 980000,
                ptaOutstanding: 245000,
                
                leviesPerHead: 8000,
                leviesExpected: 1960000,
                leviesCollected: 1568000,
                leviesOutstanding: 392000
            };
            
            // Update UI with demo data
            updateDashboardUI(demoData);
            
            // Update charts with demo data
            updateCharts({
                nurseryTotal: demoData.nurseryTotal,
                primaryTotal: demoData.primaryTotal,
                secondaryTotal: demoData.secondaryTotal,
                nurseryPaid: demoData.nurseryPaid,
                primaryPaid: demoData.primaryPaid,
                secondaryPaid: demoData.secondaryPaid,
                nurseryOutstanding: demoData.nurseryOutstanding,
                primaryOutstanding: demoData.primaryOutstanding,
                secondaryOutstanding: demoData.secondaryOutstanding
            });
            
            // Add demo recent activity
            const activityList = document.getElementById('recentActivity');
            activityList.innerHTML = '';
            
            const demoActivities = [
                { type: 'payment', text: 'John Adebayo paid ₦150,000 for tuition fees', time: '2 hours ago' },
                { type: 'enrollment', text: 'New pupil enrolled in Nursery 2', time: '4 hours ago' },
                { type: 'payment', text: 'Sarah Johnson paid ₦25,000 for PTA levy', time: '1 day ago' },
                { type: 'expense', text: '₦85,000 spent on electricity bill', time: '2 days ago' },
                { type: 'fee', text: 'Term 2 fee structure updated', time: '3 days ago' }
            ];
            
            demoActivities.forEach(activity => {
                const activityItem = createActivityItem(activity);
                activityList.appendChild(activityItem);
            });
            
            // Show demo mode notice
            showError("Dashboard is running in demo mode. Connect to Firebase for real data.");
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Update current date
            updateCurrentDate();
            
            // Try to initialize Firebase
            initializeFirebase();
            
            // Refresh data every 30 seconds
            setInterval(() => {
                if (isFirebaseConnected) {
                    loadDashboardData();
                }
            }, 30000);
        });
    </script>
</body>
</html>
